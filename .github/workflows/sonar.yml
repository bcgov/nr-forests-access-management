name: Run CI SONAR coverage for Auth Function

on:
  pull_request:

env:
  POSTGRES_USER: fam_proxy_api
  POSTGRES_PASSWORD: test
  POSTGRES_HOST: localhost
  POSTGRES_DB: fam
  POSTGRES_PORT: 5432

jobs:
  auth-function-ci:
    runs-on: ubuntu-latest

    steps:
      - name: checkout the repo and building the Backend
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - name: Run FAM API Tests
        working-directory: server/auth_function
        env:
          FC_API_TOKEN: ${{ secrets.FOREST_CLIENT_API_API_KEY }}
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install pytest-cov
          pytest --cov=. --cov-branch --cov-report=xml -v --md=report.md --emoji
          cat coverage.xml

      - run: |
          whoami
          pwd

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_AUTH }}
        with:
          projectBaseDir: server/auth_function
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.organization=bcgov-sonarcloud
            -Dsonar.projectKey=nr-forests-access-management_auth
            -Dsonar.python.coverage.reportPaths=*coverage*.xml
            -Dsonar.python.version=3.8
            -Dsonar.src=.
            -Dsonar.tests=test
            -Dsonar.verbose=true



      #     sed -i 's/\/home\/runner\/work\/nr-forests-access-management\/nr-forests-access-management\//\/github\/workspace\//g' coverage.xml
      #     cat coverage.xml

      # - name: Publish FAM API Tests
      #   working-directory: server/auth_function
      #   if: always()
      #   run: |
      #     ls
      #     sed -i 's/# Test Report/# FAM Auth Function Tests/' report.md
      #     sed -i '2i <details><summary>Click to expand!</summary>' report.md
      #     sed -i '$a</details>' report.md
      #     cat report.md >> $GITHUB_STEP_SUMMARY

      # - name: SonarCloud Scan
      #   uses: SonarSource/sonarcloud-github-action@master
      #   if: always()
      #   with:
      #     projectBaseDir: server/auth_function
      #     args: >
      #       -Dsonar.organization=bcgov-sonarcloud
      #       -Dsonar.projectKey=nr-forests-access-management_auth
      #       -Dsonar.python.coverage.reportPaths=coverage.xml
      #       -Dsonar.tests=test
      #       -Dsonar.verbose=true
      #       -Dsonar.python.version=3.8

      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_AUTH }}

      # - name: Publish FAM API Tests
      #   working-directory: server/auth_function
      #   if: always()
      #   run: |
      #     cat /github/workspace/server/auth_function/.scannerwork/report-task.txt



