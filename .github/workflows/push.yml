name: Push

on:
  push:
    branches: [dev]

env:
  TF_VERSION: 1.0.5
  environment: dev
  organization: bcgov

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: checkout the repo and building the Backend
        uses: actions/checkout@v2

      - uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.TFC_TEAM_TOKEN }}

      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'


      # Steps to deploy the sample API
      - name: Install and Package Dependencies - sample app
        run: |
          cd server/fam_api
          mkdir packaging
          cd packaging
          pip install -t . -r ../requirements.txt
          zip -r9 ../../fam-api.zip .
          cd ..
          rm -rf packaging
          cd ../../
          cd server/fam_api
          zip -u ../fam-api.zip -r app/
          cd ..


      # - name: Run Tests
      #   # Activate the virtualenv in every step
      #   # because GitHub actions doesn't preserve the environment
      #   run: |
      #     cd ./server/fam_api/
      #     . venv/bin/activate && pytest



      - name: Upload zip file artifact
        uses: actions/upload-artifact@v2
        with:
          name: fam-api
          path: ./server/fam-api.zip
          if-no-files-found: error

      # Steps to deploy Ian's python as a lambda
      - name: Install and Package Dependencies - Ians Code
        run: |
          cd server/backend
          mkdir packaging
          cd packaging
          pip install -t . -r ../requirements.txt
          zip -r9 ../../fam-ui-api.zip .
          cd ..
          rm -rf packaging
          cd ../../
          cd server/backend
          zip -u ../fam-ui-api.zip -r api/ -x database/**\* tests/**\* venv/**\* .env
          cd ..

      - name: Upload zip file artifact Kevin
        uses: actions/upload-artifact@v2
        with:
          name: fam-ui-api
          path: ./server/fam-ui-api.zip
          if-no-files-found: error

      - name: Deploying back-end using terraform
        run: |
          cd server
          cat <<EOF > backend.hcl
          organization = "${{ env.organization }}"
          workspaces { name = "${{ secrets.LICENCEPLATE }}-${{ env.environment }}-backend" }
          EOF
          cat > github.auto.tfvars <<EOF
          github_repository = "https://github.com/${{ github.repository }}"
          github_branch = "${{ github.ref_name }}"
          github_commit = "${{ github.sha }}"
          github_event = "${{ github.event_name }}"
          oidc_idir_dev_idp_client_id = "${{ secrets.OIDC_IDIR_DEV_IDP_CLIENT_ID }}"
          oidc_idir_dev_idp_client_secret = "${{ secrets.OIDC_IDIR_DEV_IDP_CLIENT_SECRET }}"
          oidc_idir_dev_idp_issuer = "${{ secrets.OIDC_IDIR_DEV_IDP_ISSUER }}"
          EOF
          terraform init -backend-config=backend.hcl
          terraform apply -auto-approve

