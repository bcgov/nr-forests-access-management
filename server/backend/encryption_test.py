from urllib.request import urlopen
import logging
from jose.utils import base64url_decode
import requests
from api.app import bcsc_decryption

LOGGER = logging.getLogger(__name__)


jwe_token = 'eyJraWQiOiJiY3NjZW5jcnlwdGlvbiIsImN0eSI6IkpXVCIsImVuYyI6IkEyNTZDQkMtSFM1MTIiLCJhbGciOiJSU0EtT0FFUC0yNTYifQ.Gw5sKcyGpUM2gLZreci3Q2GZLzq5ZVnTEj-S6iKAUtlubAuKIgTsntJ0vG6wSN5nQabFGsZanLZDj5Y7_dRILIl2dku2sg18Xg6_Wu_3ijjm4C9oPerNOjfPSwEjEtcvfi2KnIX6kB1nAxPrhK3XLNQXLImtct5OVXGzKZXUUw02MtsgH0WUW1r6wNFVC7loImxJudAGGDxq6k3cvfe6QJkPD0nLWfpfOhZiwj9nYgrG6mfoTJ4FoKYtLR9ZEHiVRZmLT_qt8tePAs4AbsMGCpYsc9pDEF3WpWK4JnTEhQ4TL6U2BXygRvQSWh-mGx5iaUU20iN5YVxTotShiNFqVQ.hX3n-2SdFn7BQSzLkMiH-Q.0WXOn6htm0DQN4gjpzxhIFwjLsIdhUavC7NFBnsub8bAV8dOqI4fZn8jpq8Sx1glZfKAOddlwGYBl9Alnxd-5-VZ5Xj-UX-mDTnrJOV4JDyYsW4vni1qSYvD0aAmqY-nZ9FEubggI6ZStW2JjysmhgwpXut5qk5-zvAwnNXE4IcmpWmHfkUMnS2RgRzzYGKWV-AYgLEUBQAqRcCRuX-EWwHFEMX44ixq6RdVFXYQQpiK1fj6UaGlBqAWJZNP-llSi_qm6CSahkbpac5k4ewAJzqg2fUX5qaZVQ383QyEJ2qzFOgp08MJ_wVscoBid6SHTYqC2TSKzNbpKzeZ-mAnAJ5xcr3H3DETRuVJ_5OR9FJcImMTIzads42RgVI3vRDc1ynDq1l8u3whta0kPewPMDYL6YIc2rqi4KCpqALgILvhIpHVQ-vywEbS9ApbbIkeF-uGXai5QJKeGil-mcSGh_KyHiw0qsE6XChvS95zc_tv8vz-iEJ3JMJ_cRBnDomEsKEJpK1e9tqaoKB_H14mhLsVxi_G-DEk-CXQoqpLkLwTWrRL9wErxBxV7IAU6_HtVKs72RLtAO0VyVf7Kqr4WET59AwWe9ySeyZ_VsASzxG-QZu8qST8UODp8ZOrSkG1dp8L-fpzLccLv6qZrxXP5ldlUYRdkdr8PkxyyEG2jI6_JZK46QNZXaxmNJqDqf4x3EVQR5ViXnBaeEv9WvSF0EpC6LP5in7J2d1F1jSAcYw1AAToGXCTevaUvgkFN2ht1Vt56d6Vrgu-BQVzB-FIO36AT8ogzFnjPPCumY8dkwItcFKZZxAkiXr7N2Sa9bv53qpkdo4q4TV0Y_A2y7eFihD2YkG5_ZO6laIdIe1xnilBEuWZr41GKhmDfgAxDQmpDxkkacY4lgESN8oYci0ejLA8Bn_nLHYo3B-WD8GvTtYg5BAs92XXUqoO3y9-_cHPOHvi-cP6GosaJL5AeLFEpqCS8-knaxM4pi0fpaULK6h4Y1UjWY93a1l0abM2dr6JAWBL6cBnyMHYGp4eOkShBaeneBbjn7UheqUlrmeJB0IIuCIgF3WSpGMHopuhb0OT-wRJxgPgrL62Pi54XWoGEWn74IOP0Ncm2Hky_H-G9EbWqdsU6pWxj7_eJ2P86BoBMQFIgWmwwYIaB9SUjlscr7i-Uc3YUcKeXPg7csMz6JLUCXIiz1wzP-iSggk9fM4DbDjq73vkm4_IO8-x4jeCbm1maH0pVDFZj3KmXJk6a6Wu5KsGUElaA0DgH73FNifOz0GOYE2U9LinFqYBkzetIkruAtzeL4KPXhjrMDJJdQ8.0-KqjLpYBi7zr70fnqTCcY9KMa4LG7ArcJbE1Ha6sH4'

encrypted_key_segment = jwe_token.split(".", 4)[1]

decrypt_url = "https://qz39ajtria.execute-api.ca-central-1.amazonaws.com/v1/bcsc/decryption_test"
encoded_decrypted_key = requests.post(url=decrypt_url, data=encrypted_key_segment).text
as_bytes = bytes(encoded_decrypted_key, 'utf-8')
decrypted_key = base64url_decode(as_bytes)

print(f"jwe_token: [{jwe_token}]")
print(f"encrypted_key_segment: [{encrypted_key_segment}]")
print(f"encoded_decrypted_key: [{encoded_decrypted_key}]")
print(f"as_bytes: [{as_bytes}]")
print(f"decrypted_key: [{decrypted_key}]")

decrypted_id_token = bcsc_decryption.decrypt(jwe_token, decrypted_key)

print(f"decrypted_id_token: [{decrypted_key}]")